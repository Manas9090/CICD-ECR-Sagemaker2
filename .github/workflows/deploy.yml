- name: Deploy to SageMaker
  run: |
    echo "Deploying image $IMAGE_URI to SageMaker..."
    
    python - <<EOF
import os
import boto3

sm = boto3.client('sagemaker', region_name='us-east-1')

model_name = 'iris-model'
endpoint_name = 'iris-endpoint'

# Read IMAGE_URI from environment
IMAGE_URI = os.environ['IMAGE_URI']

# Create or update model
try:
    sm.create_model(
        ModelName=model_name,
        PrimaryContainer={'Image': IMAGE_URI, 'Mode': 'SingleModel'},
        ExecutionRoleArn=os.environ['SAGEMAKER_ROLE_ARN']
    )
    print("âœ… Model created.")
except sm.exceptions.ResourceInUse:
    print("ðŸ” Model already exists. Skipping creation.")

# Endpoint config
endpoint_config_name = f"{model_name}-config"
try:
    sm.create_endpoint_config(
        EndpointConfigName=endpoint_config_name,
        ProductionVariants=[{
            'VariantName': 'AllTraffic',
            'ModelName': model_name,
            'InitialInstanceCount': 1,
            'InstanceType': 'ml.t2.medium',
        }],
    )
    print("âœ… Endpoint config created.")
except sm.exceptions.ResourceInUse:
    print("ðŸ” Endpoint config already exists. Skipping creation.")

# Endpoint
try:
    sm.create_endpoint(
        EndpointName=endpoint_name,
        EndpointConfigName=endpoint_config_name
    )
    print("ðŸš€ Endpoint creation started.")
except sm.exceptions.ResourceInUse:
    print("ðŸ” Updating existing endpoint...")
    sm.update_endpoint(
        EndpointName=endpoint_name,
        EndpointConfigName=endpoint_config_name
    )
    print("âœ… Endpoint update initiated.")
EOF
  env:
    IMAGE_URI: 491085388405.dkr.ecr.us-east-1.amazonaws.com/my-sagemaker-image:latest
    SAGEMAKER_ROLE_ARN: ${{ secrets.SAGEMAKER_ROLE_ARN }}
